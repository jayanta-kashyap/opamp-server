# Build custom OpAMP server with enhanced UI
FROM golang:1.23 AS builder
WORKDIR /src
COPY . .
RUN go mod download
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o /out/opamp-server ./cmd/server

# Minimal runtime image
FROM gcr.io/distroless/base-debian11
COPY --from=builder /out/opamp-server /opamp-server
COPY --from=builder /src/internal/ui/dashboard.html /internal/ui/dashboard.html
EXPOSE 4320 4321
# 4320: OpAMP WebSocket endpoint, 4321: HTTP UI + API
ENTRYPOINT ["/opamp-server"]
