<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpAMP Device Management</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
            min-height: 100vh;
            color: #333333;
        }
        
        /* Layout */
        .app-container { display: flex; height: 100vh; }
        .sidebar {
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px 30px;
        }
        
        /* Sidebar Header */
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        .sidebar-header h1 {
            font-size: 1.3em;
            color: #333333;
            margin-bottom: 3px;
        }
        .sidebar-header p { font-size: 0.75em; color: #888; }
        
        /* Stats Row */
        .stats-row {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        .stat-box {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 8px;
        }
        .stat-value { font-size: 1.4em; font-weight: 700; color: #333333; }
        .stat-label { font-size: 0.65em; color: #888; margin-top: 2px; }
        
        /* Search */
        .search-container { padding: 15px 20px; }
        .search-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            background: #ffffff;
            color: #333333;
            font-size: 13px;
        }
        .search-input:focus { outline: none; border-color: #666; }
        
        /* Device List */
        .device-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 10px 10px;
        }
        .device-list::-webkit-scrollbar { width: 6px; }
        .device-list::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.2); border-radius: 3px; }
        
        .device-item {
            padding: 12px 15px;
            margin: 5px 0;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            background: #ffffff;
        }
        .device-item:hover { border-color: rgba(0, 0, 0, 0.2); background: #f8f8f8; }
        .device-item.selected { border-color: #333333; background: #f0f0f0; }
        .device-item-header { display: flex; justify-content: space-between; align-items: center; }
        .device-item-name { font-weight: 600; font-size: 0.9em; }
        .device-item-badge {
            font-size: 0.6em;
            padding: 3px 8px;
            border-radius: 10px;
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
            font-weight: 600;
        }
        .device-item-meta { display: flex; gap: 8px; align-items: center; margin-top: 6px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-dot.online { background: #4caf50; box-shadow: 0 0 6px #4caf50; }
        .status-dot.offline { background: #666; }
        .meta-tag { font-size: 0.7em; color: #888; }
        .emission-tag {
            font-size: 0.6em;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
            margin-left: auto;
        }
        .emission-tag.on { background: rgba(76, 175, 80, 0.3); color: #81c784; }
        .emission-tag.off { background: rgba(100, 100, 100, 0.3); color: #888; }
        .device-delete-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.85em;
            padding: 2px 4px;
            border-radius: 4px;
            opacity: 0.5;
            transition: all 0.15s;
        }
        .device-delete-btn:hover { opacity: 1; background: rgba(255, 0, 0, 0.1); }
        
        /* Main Content - No Selection */
        .no-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #555;
        }
        .no-selection-icon { font-size: 4em; margin-bottom: 15px; opacity: 0.5; }
        .no-selection h2 { font-size: 1.2em; color: #888; margin-bottom: 8px; }
        .no-selection p { font-size: 0.9em; }
        
        /* Device Detail View */
        .device-detail { display: none; }
        .device-detail.active { display: block; }
        
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        .detail-title-section { display: flex; align-items: center; gap: 15px; }
        .detail-title { font-size: 1.5em; font-weight: 600; color: #333; }
        .detail-badge {
            font-size: 0.7em;
            padding: 5px 12px;
            border-radius: 15px;
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
            font-weight: 600;
        }
        
        /* Emission Toggle */
        .emission-control {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        .emission-control-label { font-size: 0.85em; color: #666; }
        .toggle-switch {
            position: relative;
            width: 54px;
            height: 28px;
            background: #ccc;
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .toggle-switch.on { background: #4caf50; }
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.2s;
        }
        .toggle-switch.on::after { left: 28px; }
        .toggle-switch.locked { cursor: not-allowed; opacity: 0.7; }
        .emission-status {
            font-size: 0.75em;
            padding: 4px 10px;
            border-radius: 8px;
        }
        .emission-status.active { background: rgba(76, 175, 80, 0.2); color: #81c784; }
        .emission-status.inactive { background: rgba(100, 100, 100, 0.2); color: #888; }
        
        /* POC Banner */
        .poc-banner {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 1px solid #f0d77c;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .poc-banner-icon { font-size: 1.2em; }
        .poc-banner-text { font-size: 0.85em; color: #856404; line-height: 1.4; }
        
        /* Section Headers */
        .section-header {
            font-size: 1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section-header .section-icon { font-size: 1.1em; }
        
        /* Two Column Layout */
        .dual-panel-container {
            display: flex;
            gap: 25px;
            align-items: stretch;
        }
        
        .panel-left {
            flex: 0 0 35%;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }
        
        .panel-right {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }
        
        .panel-card {
            background: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .panel-card .policy-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .panel-card .policy-section-wrapper {
            flex: 1;
            overflow-y: auto;
        }
        
        /* Policy Cards */
        .policy-section { margin-bottom: 25px; }
        .policy-section-title {
            font-size: 1em;
            color: #333333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .policy-section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(0, 0, 0, 0.1);
        }
        
        .policy-card {
            background: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .policy-card:hover { border-color: rgba(0, 0, 0, 0.25); }
        
        .policy-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        .policy-info { flex: 1; }
        .policy-name { font-size: 1.05em; font-weight: 600; color: #333; margin-bottom: 4px; }
        .policy-desc { font-size: 0.8em; color: #666; line-height: 1.4; }
        
        .policy-toggle {
            padding: 6px 14px;
            border: 1px solid rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            background: transparent;
            color: #333333;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .policy-toggle:hover { background: rgba(0, 0, 0, 0.05); }
        .policy-toggle.active { 
            background: #333333; 
            color: #ffffff;
            border-color: #333333;
        }
        
        /* Enabled policy card styling */
        .policy-card.policy-enabled {
            border-color: #333333;
            background: #f8f8f8;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Form Controls */
        .form-group { margin-bottom: 15px; }
        .form-label {
            display: block;
            font-size: 0.8em;
            color: #666;
            margin-bottom: 6px;
            font-weight: 500;
        }
        .form-row { display: flex; gap: 15px; }
        .form-row .form-group { flex: 1; }
        
        .form-input, .form-select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            background: #ffffff;
            color: #333333;
            font-size: 0.9em;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #666;
        }
        .form-select { cursor: pointer; }
        .form-select option { background: #ffffff; }
        
        .form-hint { font-size: 0.7em; color: #666; margin-top: 4px; }
        
        /* Checkbox Pills */
        .checkbox-pills { display: flex; flex-wrap: wrap; gap: 8px; }
        .checkbox-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8em;
        }
        .checkbox-pill:hover { border-color: rgba(0, 0, 0, 0.3); }
        .checkbox-pill.selected { border-color: #333333; background: #333333; color: #ffffff; }
        .checkbox-pill input { display: none; }
        
        /* Apply Button */
        .policy-actions { margin-top: 20px; display: flex; gap: 10px; }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: linear-gradient(135deg, #333333, #555555); color: #fff; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
        .btn-secondary { background: rgba(0, 0, 0, 0.08); color: #333; }
        .btn-secondary:hover:not(:disabled) { background: rgba(0, 0, 0, 0.12); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Message Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: 500;
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: rgba(76, 175, 80, 0.95); color: white; }
        .toast.error { background: rgba(244, 67, 54, 0.95); color: white; }
        
        /* Config Preview */
        .config-preview {
            background: #f5f5f5;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        .config-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .config-preview-title { font-size: 0.8em; color: #666; }
        .config-preview-code {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.75em;
            line-height: 1.5;
            color: #555;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* Raw Config Tab */
        .raw-config-area {
            width: 100%;
            height: 180px;
            padding: 12px;
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            background: #ffffff;
            color: #333333;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8em;
            line-height: 1.4;
            resize: vertical;
        }
        .raw-config-area:focus { outline: none; border-color: #666; }
        
        /* Current Config Display */
        .current-config-section { margin-bottom: 20px; }
        .current-config-box {
            background: #f5f5f5;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.75em;
            line-height: 1.4;
            max-height: 180px;
            overflow-y: auto;
            white-space: pre-wrap;
            color: #555;
        }
        
        /* Live Logs Display */
        .live-logs-section { margin-bottom: 20px; }
        .live-logs-box {
            background: #1a1a2e;
            border: 1px solid #16213e;
            border-radius: 10px;
            padding: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.72em;
            line-height: 1.5;
            max-height: 120px;
            overflow-y: auto;
            white-space: pre-wrap;
            color: #4ade80;
        }
        .live-indicator {
            font-size: 0.7em;
            color: #4ade80;
            animation: pulse 1.5s ease-in-out infinite;
        }
        .live-indicator.stopped { color: #888; animation: none; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* Loading */
        .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(0,0,0,0.2); border-top-color: #333; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Policy Section Container */
        .policy-container {
            position: relative;
        }
        
        /* Policy Disabled Overlay - floats over watermarked content */
        .policy-disabled-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            z-index: 10;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 12px;
        }
        .policy-disabled-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .policy-disabled-overlay .overlay-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px 25px;
            text-align: center;
            background: rgba(255, 255, 255, 0.92);
            border: 2px dashed rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.15);
        }
        .policy-disabled-overlay .overlay-icon {
            font-size: 2.5em;
            margin-bottom: 12px;
            opacity: 0.7;
        }
        .policy-disabled-overlay .overlay-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }
        .policy-disabled-overlay .overlay-desc {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 15px;
            max-width: 350px;
            line-height: 1.4;
        }
        .policy-disabled-overlay .overlay-hint {
            font-size: 0.75em;
            color: #888;
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 6px;
        }
        
        /* Watermark effect on policy cards when disabled */
        .policy-section-wrapper {
            display: block;
            transition: opacity 0.3s, filter 0.3s;
        }
        .policy-section-wrapper.disabled {
            opacity: 0.55;
            filter: grayscale(0.3);
            pointer-events: none;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .dual-panel-container { flex-direction: column; }
            .panel-left, .panel-right { width: 100%; }
        }
        @media (max-width: 900px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; height: auto; max-height: 50vh; }
            .main-content { padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar: Device List -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>OpAMP Control</h1>
                <p>Edge Device Management</p>
            </div>
            
            <!-- POC: Deploy Test Device -->
            <div class="poc-deploy-section" style="padding:10px 20px;border-bottom:1px solid rgba(0,0,0,0.1);">
                <button class="btn btn-primary" style="width:100%;padding:8px;font-size:0.8em;" onclick="deployTestDevice()">
                    ‚ûï Deploy Test Device
                </button>
                <div style="font-size:0.65em;color:#888;margin-top:5px;text-align:center;">POC Only ‚Ä¢ Click üóëÔ∏è on device to remove</div>
            </div>
            
            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-value" id="totalDevices">0</div>
                    <div class="stat-label">DEVICES</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="connectedDevices">0</div>
                    <div class="stat-label">ONLINE</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="emittingDevices">0</div>
                    <div class="stat-label">EMITTING</div>
                </div>
            </div>
            
            <div class="search-container">
                <input type="text" class="search-input" id="searchBox" placeholder="Search devices..." oninput="filterDevices()">
            </div>
            
            <div class="device-list" id="deviceList">
                <div style="text-align:center;padding:30px;color:#666;">
                    <span class="loading"></span>
                    <p style="margin-top:10px;font-size:0.85em;">Loading devices...</p>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- No Selection State -->
            <div class="no-selection" id="noSelection">
                <div class="no-selection-icon">üì°</div>
                <h2>Select a Device</h2>
                <p>Choose a device from the sidebar to configure data policies</p>
            </div>
            
            <!-- Device Detail View -->
            <div class="device-detail" id="deviceDetail">
                <div class="detail-header">
                    <div class="detail-title-section">
                        <span class="detail-title" id="detailDeviceName">-</span>
                        <span class="detail-badge">Fluent Bit</span>
                    </div>
                    <div class="emission-control">
                        <span class="emission-control-label">Data Emission</span>
                        <div class="toggle-switch" id="emissionToggle" onclick="toggleEmission()"></div>
                        <span class="emission-status" id="emissionStatus">OFF</span>
                    </div>
                </div>
                
                <!-- POC Limitation Banner -->
                <div class="poc-banner" id="pocBanner" style="display:none;">
                    <span class="poc-banner-icon">‚ÑπÔ∏è</span>
                    <span class="poc-banner-text">POC Limitation: Toggle OFF requires custom FluentBit image with policy_type support. In production, devices will use block_all/allow_all policies for emission control.</span>
                </div>
                
                <!-- Two Column Layout: Raw Config (Left) | Data Policies (Right) -->
                <div class="dual-panel-container">
                    <!-- LEFT PANEL: Raw Configuration (Always Active) -->
                    <div class="panel-left">
                        <div class="panel-card">
                            <div class="section-header">
                                <span class="section-icon">üìù</span>
                                <span>Raw Configuration</span>
                            </div>
                            
                            <div class="current-config-section">
                                <div class="form-label" style="display:flex;justify-content:space-between;align-items:center;">
                                    <span>Current Device Config (Live)</span>
                                    <button class="btn btn-secondary" style="padding:4px 10px;font-size:0.75em;" onclick="refreshConfig()">Refresh</button>
                                </div>
                                <div class="current-config-box" id="currentConfigBox">Loading...</div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Push Custom Configuration</label>
                                <textarea class="raw-config-area" id="rawConfigArea" placeholder="Paste your Fluent Bit configuration here..."></textarea>
                            </div>
                            
                            <div class="policy-actions">
                                <button class="btn btn-primary" onclick="pushRawConfig()">Push Config</button>
                                <button class="btn btn-secondary" onclick="loadDefaultTemplate()">Template</button>
                            </div>
                            
                            <!-- Live FluentBit Logs -->
                            <div class="live-logs-section" id="liveLogsSection" style="display:none;margin-top:15px;">
                                <div class="form-label" style="display:flex;justify-content:space-between;align-items:center;">
                                    <span>üì° Live FluentBit Output</span>
                                    <span class="live-indicator" id="liveIndicator">‚óè LIVE</span>
                                </div>
                                <div class="live-logs-box" id="liveLogsBox">Waiting for logs...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RIGHT PANEL: Data Policies -->
                    <div class="panel-right">
                        <div class="panel-card">
                            <div class="section-header">
                                <span class="section-icon">üéõÔ∏è</span>
                                <span>Data Policies</span>
                            </div>
                    
                            <div class="policy-container" id="policyContainer">
                                <!-- Disabled Overlay - floats over watermarked content -->
                        <div class="policy-disabled-overlay show" id="policyDisabledOverlay">
                            <div class="overlay-content">
                                <div class="overlay-icon">‚ö°</div>
                                <div class="overlay-title">Data Emission is OFF</div>
                                <div class="overlay-desc">Turn on the emission toggle above to start emitting data and configure policies.</div>
                                <div class="overlay-hint">üí° Toggle ON above or push a config to auto-enable</div>
                            </div>
                        </div>
                        
                        <div class="policy-section-wrapper disabled" id="policySectionWrapper">
                        <div class="policy-section">
                            <div class="policy-section-title">Configure Data Control Policies</div>
                            
                            <!-- Throttle Policy -->
                            <div class="policy-card" id="throttleCard">
                                <div class="policy-header">
                                    <div class="policy-info">
                                        <div class="policy-name">üö¶ Rate Limiting (Throttle)</div>
                                        <div class="policy-desc">Limit the number of logs processed per time window to control data volume</div>
                                    </div>
                                    <button class="policy-toggle" id="throttleToggle" onclick="togglePolicy('throttle')">Include</button>
                                </div>
                                <div class="policy-form" id="throttleForm">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Max Logs per Window</label>
                                            <select class="form-select" id="throttleRate">
                                                <option value="1">1 log</option>
                                                <option value="3" selected>3 logs</option>
                                                <option value="5">5 logs</option>
                                                <option value="10">10 logs</option>
                                                <option value="20">20 logs</option>
                                                <option value="50">50 logs</option>
                                                <option value="100">100 logs</option>
                                            </select>
                                            <div class="form-hint">Maximum logs allowed through per window</div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Time Window (seconds)</label>
                                            <select class="form-select" id="throttleWindow">
                                                <option value="1">1 second</option>
                                                <option value="5" selected>5 seconds</option>
                                                <option value="10">10 seconds</option>
                                                <option value="30">30 seconds</option>
                                                <option value="60">1 minute</option>
                                            </select>
                                            <div class="form-hint">Time period for rate calculation</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Grep Policy -->
                            <div class="policy-card" id="grepCard">
                                <div class="policy-header">
                                    <div class="policy-info">
                                        <div class="policy-name">üîç Log Level Filter (Grep)</div>
                                        <div class="policy-desc">Filter logs by severity level - only forward important logs to reduce noise</div>
                                    </div>
                                    <button class="policy-toggle" id="grepToggle" onclick="togglePolicy('grep')">Include</button>
                                </div>
                                <div class="policy-form" id="grepForm">
                                    <div class="form-group">
                                        <label class="form-label">Include Log Levels</label>
                                        <div class="checkbox-pills" id="logLevelPills">
                                            <div class="checkbox-pill" onclick="togglePill(event, this)">
                                                <input type="checkbox" value="debug">
                                                <span>Debug</span>
                                            </div>
                                            <div class="checkbox-pill" onclick="togglePill(event, this)">
                                                <input type="checkbox" value="info">
                                                <span>Info</span>
                                            </div>
                                            <div class="checkbox-pill selected" onclick="togglePill(event, this)">
                                                <input type="checkbox" value="warn" checked>
                                                <span>Warning</span>
                                            </div>
                                            <div class="checkbox-pill selected" onclick="togglePill(event, this)">
                                                <input type="checkbox" value="error" checked>
                                                <span>Error</span>
                                            </div>
                                            <div class="checkbox-pill selected" onclick="togglePill(event, this)">
                                                <input type="checkbox" value="fatal" checked>
                                                <span>Fatal</span>
                                            </div>
                                        </div>
                                        <div class="form-hint">Click to select levels - logs matching ANY selected level will be forwarded</div>
                                    </div>
                                    <input type="hidden" id="grepField" value="level">
                                </div>
                            </div>
                            
                            <!-- Modify Policy -->
                            <div class="policy-card" id="modifyCard">
                                <div class="policy-header">
                                    <div class="policy-info">
                                        <div class="policy-name">‚úÇÔ∏è Field Removal (Modify)</div>
                                        <div class="policy-desc">Remove sensitive or unnecessary fields from logs before forwarding</div>
                                    </div>
                                    <button class="policy-toggle" id="modifyToggle" onclick="togglePolicy('modify')">Include</button>
                                </div>
                                <div class="policy-form" id="modifyForm">
                                    <div class="form-group">
                                        <label class="form-label">Fields to Remove</label>
                                        <div class="checkbox-pills" id="removeFieldPills">
                                            <div class="checkbox-pill selected" onclick="togglePill(event, this)">
                                                <input type="checkbox" value="password" checked>
                                                <span>password</span>
                                            </div>
                                            <div class="checkbox-pill selected" onclick="togglePill(event, this)">
                                                <input type="checkbox" value="secret" checked>
                                                <span>secret</span>
                                            </div>
                                            <div class="checkbox-pill" onclick="togglePill(event, this)">
                                                <input type="checkbox" value="token">
                                                <span>token</span>
                                            </div>
                                            <div class="checkbox-pill" onclick="togglePill(event, this)">
                                                <input type="checkbox" value="api_key">
                                                <span>api_key</span>
                                            </div>
                                            <div class="checkbox-pill" onclick="togglePill(event, this)">
                                                <input type="checkbox" value="credit_card">
                                                <span>credit_card</span>
                                            </div>
                                        </div>
                                        <div class="form-hint">Click to select fields to remove from logs</div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Custom Fields (comma separated)</label>
                                        <input type="text" class="form-input" id="customRemoveFields" placeholder="e.g., ssn, private_data, internal_id">
                                        <div class="form-hint">Additional fields to remove from logs</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Config Preview -->
                        <div class="config-preview" id="configPreview">
                            <div class="config-preview-header">
                                <span class="config-preview-title">Generated Configuration Preview</span>
                            </div>
                            <div class="config-preview-code" id="previewCode">Enable policies above to see the generated config...</div>
                        </div>
                        
                        <div class="policy-actions">
                            <button class="btn btn-primary" id="applyBtn" onclick="applyPolicies()">Apply Policies</button>
                            <button class="btn btn-secondary" onclick="resetPolicies()">Reset</button>
                        </div>
                        </div><!-- end policy-section-wrapper -->
                    </div><!-- end policy-container -->
                        </div><!-- end panel-card -->
                    </div><!-- end panel-right -->
                </div><!-- end dual-panel-container -->
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // State
        var state = {
            devices: [],
            selected: null,
            policies: {
                throttle: { enabled: false, rate: 3, window: 5 },
                grep: { enabled: false, levels: ['warn', 'error', 'fatal'], field: 'level' },
                modify: { enabled: false, fields: ['password', 'secret'], custom: '' }
            }
        };

        // ============== Device List ==============
        function fetchDevices() {
            fetch('/api/devices')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    state.devices = (data.devices || []).filter(function(d) {
                        return d.id && d.id.match(/^[a-zA-Z0-9-_]+$/);
                    });
                    updateStats();
                    renderDeviceList();
                })
                .catch(function(e) { console.error('Fetch error:', e); });
        }

        function updateStats() {
            var total = state.devices.length;
            var connected = 0, emitting = 0;
            state.devices.forEach(function(d) {
                if (d.connected) connected++;
                if (d.emission_enabled) emitting++;
            });
            document.getElementById('totalDevices').textContent = total;
            document.getElementById('connectedDevices').textContent = connected;
            document.getElementById('emittingDevices').textContent = emitting;
        }

        function filterDevices() {
            renderDeviceList();
        }

        function renderDeviceList() {
            var search = document.getElementById('searchBox').value.toLowerCase();
            var list = document.getElementById('deviceList');
            var filtered = state.devices.filter(function(d) {
                if (!search) return true;
                return d.id.toLowerCase().indexOf(search) >= 0;
            });
            
            // Natural sort: device-1, device-2, ..., device-10 (not device-1, device-10, device-2)
            filtered.sort(function(a, b) {
                var regex = /(\d+)/g;
                var aParts = a.id.split(regex);
                var bParts = b.id.split(regex);
                for (var i = 0; i < Math.max(aParts.length, bParts.length); i++) {
                    var aPart = aParts[i] || '';
                    var bPart = bParts[i] || '';
                    var aNum = parseInt(aPart, 10);
                    var bNum = parseInt(bPart, 10);
                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        if (aNum !== bNum) return aNum - bNum;
                    } else {
                        if (aPart !== bPart) return aPart.localeCompare(bPart);
                    }
                }
                return 0;
            });

            if (filtered.length === 0) {
                list.innerHTML = '<div style="text-align:center;padding:30px;color:#666;font-size:0.85em;">' +
                    (state.devices.length === 0 ? 'No devices connected' : 'No devices match search') + '</div>';
                return;
            }

            var html = '';
            filtered.forEach(function(d) {
                var sel = state.selected === d.id ? 'selected' : '';
                var deviceNum = d.id.match(/device-(\d+)/);
                var canDelete = deviceNum ? true : false;
                html += '<div class="device-item ' + sel + '" onclick="selectDevice(\'' + d.id + '\')">';
                html += '<div class="device-item-header">';
                html += '<span class="device-item-name">' + d.id + '</span>';
                html += '<div style="display:flex;gap:6px;align-items:center;">';
                if (canDelete) {
                    html += '<button class="device-delete-btn" onclick="event.stopPropagation();removeDevice(' + deviceNum[1] + ')" title="Remove ' + d.id + '">üóëÔ∏è</button>';
                }
                html += '<span class="device-item-badge">FB</span>';
                html += '</div></div>';
                html += '<div class="device-item-meta">';
                html += '<span class="status-dot ' + (d.connected ? 'online' : 'offline') + '"></span>';
                html += '<span class="meta-tag">' + (d.pipeline || 'default') + '</span>';
                html += '<span class="emission-tag ' + (d.emission_enabled ? 'on' : 'off') + '">' + 
                    (d.emission_enabled ? 'EMITTING' : 'OFF') + '</span>';
                html += '</div></div>';
            });
            list.innerHTML = html;
        }

        function selectDevice(id) {
            state.selected = id;
            renderDeviceList();
            
            document.getElementById('noSelection').style.display = 'none';
            document.getElementById('deviceDetail').classList.add('active');
            document.getElementById('detailDeviceName').textContent = id;
            
            var d = state.devices.find(function(x) { return x.id === id; });
            updateEmissionUI(d ? d.emission_enabled : false);
            
            // Pre-populate raw config area with template (helps users unfamiliar with FluentBit)
            document.getElementById('rawConfigArea').value = getDefaultBaseConfig();
            
            resetPolicies();
            refreshConfig();
            updatePreview();
        }

        // ============== Emission Control ==============
        var liveLogInterval = null;
        
        function updateEmissionUI(isOn) {
            var toggle = document.getElementById('emissionToggle');
            var status = document.getElementById('emissionStatus');
            var pocBanner = document.getElementById('pocBanner');
            toggle.classList.toggle('on', isOn);
            toggle.classList.toggle('locked', isOn);  // Lock toggle when ON (POC limitation)
            status.textContent = isOn ? 'ACTIVE' : 'OFF';
            status.className = 'emission-status ' + (isOn ? 'active' : 'inactive');
            
            // Show POC banner when emission is ON to explain toggle OFF is disabled
            pocBanner.style.display = isOn ? 'flex' : 'none';
            
            // Show/hide policy overlay based on emission state
            var overlay = document.getElementById('policyDisabledOverlay');
            var wrapper = document.getElementById('policySectionWrapper');
            if (isOn) {
                overlay.classList.remove('show');
                wrapper.classList.remove('disabled');
            } else {
                overlay.classList.add('show');
                wrapper.classList.add('disabled');
            }
            
            // Show/hide live logs section and start/stop polling
            var logsSection = document.getElementById('liveLogsSection');
            var indicator = document.getElementById('liveIndicator');
            logsSection.style.display = 'block';
            
            if (isOn) {
                indicator.classList.remove('stopped');
                indicator.textContent = '‚óè EMITTING';
            } else {
                indicator.classList.add('stopped');
                indicator.textContent = '‚óè SILENT';
            }
            // Always poll logs to show real pod output
            startLiveLogPolling();
        }

        function toggleEmission() {
            var d = state.devices.find(function(x) { return x.id === state.selected; });
            if (!d || !d.connected) return;
            
            var newState = !d.emission_enabled;
            var action = newState ? 'enable' : 'disable';
            
            // POC Limitation: Toggle OFF is disabled
            if (!newState) {
                showToast('POC Limitation: Toggle OFF requires custom FluentBit with policy_type support', 'info');
                return;
            }
            
            // Toggle switch visual immediately for responsiveness
            var toggle = document.getElementById('emissionToggle');
            toggle.classList.add('locked');
            
            fetch('/api/devices/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ deviceId: state.selected, setEmission: newState })
            })
            .then(function(r) { return r.json(); })
            .then(function(res) {
                toggle.classList.remove('locked');
                if (res.success) {
                    d.emission_enabled = newState;
                    updateEmissionUI(newState);
                    updateStats();
                    renderDeviceList();
                    var msg = newState ? 'Data emission ENABLED' : 'Data emission DISABLED (stopped)';
                    showToast(msg + ' for ' + state.selected, newState ? 'success' : 'info');
                    setTimeout(refreshConfig, 500);
                } else {
                    showToast('Failed: ' + res.error, 'error');
                }
            })
            .catch(function(e) { 
                toggle.classList.remove('locked');
                showToast('Error: ' + e.message, 'error'); 
            });
        }

        // ============== Policy Controls ==============
        function togglePolicy(policy) {
            state.policies[policy].enabled = !state.policies[policy].enabled;
            var btn = document.getElementById(policy + 'Toggle');
            var card = document.getElementById(policy + 'Card');
            
            if (state.policies[policy].enabled) {
                btn.classList.add('active');
                btn.textContent = '‚úì Included';
                card.classList.add('policy-enabled');
            } else {
                btn.classList.remove('active');
                btn.textContent = 'Include';
                card.classList.remove('policy-enabled');
            }
            updatePreview();
        }

        function togglePill(event, el) {
            event.preventDefault();
            event.stopPropagation();
            el.classList.toggle('selected');
            var cb = el.querySelector('input');
            cb.checked = el.classList.contains('selected');
            updatePolicyState();
            updatePreview();
        }

        function updatePolicyState() {
            // Update grep levels
            var levels = [];
            document.querySelectorAll('#logLevelPills .checkbox-pill.selected input').forEach(function(cb) {
                levels.push(cb.value);
            });
            state.policies.grep.levels = levels;
            state.policies.grep.field = document.getElementById('grepField').value;

            // Update modify fields
            var fields = [];
            document.querySelectorAll('#removeFieldPills .checkbox-pill.selected input').forEach(function(cb) {
                fields.push(cb.value);
            });
            state.policies.modify.fields = fields;
            state.policies.modify.custom = document.getElementById('customRemoveFields').value;

            // Update throttle
            state.policies.throttle.rate = document.getElementById('throttleRate').value;
            state.policies.throttle.window = document.getElementById('throttleWindow').value;
        }

        function resetPolicies() {
            state.policies = {
                throttle: { enabled: false, rate: 3, window: 5 },
                grep: { enabled: false, levels: ['warn', 'error', 'fatal'], field: 'level' },
                modify: { enabled: false, fields: ['password', 'secret'], custom: '' }
            };
            
            ['throttle', 'grep', 'modify'].forEach(function(p) {
                document.getElementById(p + 'Toggle').classList.remove('active');
                document.getElementById(p + 'Toggle').textContent = 'Include';
                document.getElementById(p + 'Card').classList.remove('policy-enabled');
            });
            
            // Reset pills to default
            document.querySelectorAll('#logLevelPills .checkbox-pill').forEach(function(pill) {
                var val = pill.querySelector('input').value;
                var shouldSelect = ['warn', 'error', 'fatal'].indexOf(val) >= 0;
                pill.classList.toggle('selected', shouldSelect);
                pill.querySelector('input').checked = shouldSelect;
            });
            
            document.querySelectorAll('#removeFieldPills .checkbox-pill').forEach(function(pill) {
                var val = pill.querySelector('input').value;
                var shouldSelect = ['password', 'secret'].indexOf(val) >= 0;
                pill.classList.toggle('selected', shouldSelect);
                pill.querySelector('input').checked = shouldSelect;
            });
            
            document.getElementById('customRemoveFields').value = '';
            document.getElementById('throttleRate').value = '3';
            document.getElementById('throttleWindow').value = '5';
            document.getElementById('grepField').value = 'level';
            
            updatePreview();
        }

        // ============== Config Generation ==============
        // Parse existing config into sections
        function parseConfig(configStr) {
            var sections = { service: '', inputs: [], filters: [], outputs: [] };
            if (!configStr) return sections;
            
            var lines = configStr.split('\n');
            var currentSection = null;
            var currentContent = '';
            
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i];
                var sectionMatch = line.match(/^\[(\w+)\]/i);
                
                if (sectionMatch) {
                    // Save previous section
                    if (currentSection && currentContent.trim()) {
                        if (currentSection === 'SERVICE') {
                            sections.service = currentContent;
                        } else if (currentSection === 'INPUT') {
                            sections.inputs.push(currentContent);
                        } else if (currentSection === 'FILTER') {
                            sections.filters.push(currentContent);
                        } else if (currentSection === 'OUTPUT') {
                            sections.outputs.push(currentContent);
                        }
                    }
                    currentSection = sectionMatch[1].toUpperCase();
                    currentContent = line + '\n';
                } else if (currentSection) {
                    currentContent += line + '\n';
                }
            }
            
            // Save last section
            if (currentSection && currentContent.trim()) {
                if (currentSection === 'SERVICE') {
                    sections.service = currentContent;
                } else if (currentSection === 'INPUT') {
                    sections.inputs.push(currentContent);
                } else if (currentSection === 'FILTER') {
                    sections.filters.push(currentContent);
                } else if (currentSection === 'OUTPUT') {
                    sections.outputs.push(currentContent);
                }
            }
            
            return sections;
        }
        
        // Get current device config from state
        function getCurrentDeviceConfig() {
            var d = state.devices.find(function(x) { return x.id === state.selected; });
            return d ? d.config : '';
        }
        
        // Generate default base config with varied log levels for testing policies
        function getDefaultBaseConfig() {
            var deviceId = state.selected || 'device-1';
            return '[SERVICE]\n' +
                '    flush        5\n' +
                '    daemon       Off\n' +
                '    log_level    info\n' +
                '    http_server  On\n' +
                '    http_listen  0.0.0.0\n' +
                '    http_port    2020\n' +
                '    hot_reload   On\n\n' +
                '[INPUT]\n' +
                '    name         dummy\n' +
                '    tag          poc.info\n' +
                '    dummy        {"level":"info","event":"user_login","user_id":"user123","message":"User authenticated","device":"' + deviceId + '"}\n' +
                '    rate         1\n\n' +
                '[INPUT]\n' +
                '    name         dummy\n' +
                '    tag          poc.info\n' +
                '    dummy        {"level":"info","event":"payment_processed","amount":99.99,"message":"Payment completed","device":"' + deviceId + '"}\n' +
                '    rate         1\n\n' +
                '[INPUT]\n' +
                '    name         dummy\n' +
                '    tag          poc.warn\n' +
                '    dummy        {"level":"warn","event":"high_cpu","cpu_percent":85,"message":"CPU usage high","device":"' + deviceId + '"}\n' +
                '    rate         1\n\n' +
                '[INPUT]\n' +
                '    name         dummy\n' +
                '    tag          poc.error\n' +
                '    dummy        {"level":"error","event":"connection_failed","service":"database","message":"Database connection failed","device":"' + deviceId + '"}\n' +
                '    rate         1\n\n' +
                '[INPUT]\n' +
                '    name         dummy\n' +
                '    tag          poc.debug\n' +
                '    dummy        {"level":"debug","event":"cache_hit","key":"session_abc","message":"Cache lookup success","device":"' + deviceId + '"}\n' +
                '    rate         1\n\n' +
                '[INPUT]\n' +
                '    name         dummy\n' +
                '    tag          poc.info\n' +
                '    dummy        {"level":"info","event":"api_request","method":"GET","path":"/api/users","message":"API request done","device":"' + deviceId + '"}\n' +
                '    rate         1\n\n' +
                '[OUTPUT]\n' +
                '    name         stdout\n' +
                '    match        *\n' +
                '    format       json_lines\n';
        }

        function generateConfig() {
            updatePolicyState();
            
            // Get existing device config or use default
            var existingConfig = getCurrentDeviceConfig();
            var baseConfig = existingConfig || getDefaultBaseConfig();
            var parsed = parseConfig(baseConfig);
            
            // Build new config preserving SERVICE, INPUT, OUTPUT
            var cfg = '';
            
            // Add SERVICE section (preserved from device)
            if (parsed.service) {
                cfg += parsed.service + '\n';
            }
            
            // Add INPUT sections (preserved from device)
            parsed.inputs.forEach(function(input) {
                cfg += input + '\n';
            });
            
            // Add new FILTER sections based on policies (replacing old filters)
            if (state.policies.throttle.enabled) {
                cfg += '[FILTER]\n' +
                    '    name         throttle\n' +
                    '    match        *\n' +
                    '    rate         ' + state.policies.throttle.rate + '\n' +
                    '    window       ' + state.policies.throttle.window + '\n' +
                    '    print_status true\n\n';
            }
            
            if (state.policies.grep.enabled && state.policies.grep.levels.length > 0) {
                var pattern = state.policies.grep.levels.join('|');
                cfg += '[FILTER]\n' +
                    '    name         grep\n' +
                    '    match        *\n' +
                    '    regex        ' + state.policies.grep.field + ' ^(' + pattern + ')$\n\n';
            }
            
            if (state.policies.modify.enabled) {
                var allFields = state.policies.modify.fields.slice();
                if (state.policies.modify.custom) {
                    state.policies.modify.custom.split(',').forEach(function(f) {
                        var trimmed = f.trim();
                        if (trimmed) allFields.push(trimmed);
                    });
                }
                if (allFields.length > 0) {
                    cfg += '[FILTER]\n' +
                        '    name         modify\n' +
                        '    match        *\n';
                    allFields.forEach(function(f) {
                        cfg += '    remove       ' + f + '\n';
                    });
                    cfg += '\n';
                }
            }
            
            // Add OUTPUT sections (preserved from device)
            parsed.outputs.forEach(function(output) {
                cfg += output;
            });
            
            return cfg.trim();
        }

        function updatePreview() {
            var preview = document.getElementById('previewCode');
            var hasPolicy = state.policies.throttle.enabled || 
                           state.policies.grep.enabled || 
                           state.policies.modify.enabled;
            
            if (!hasPolicy) {
                preview.textContent = 'Enable policies above to see the generated config...';
            } else {
                preview.textContent = generateConfig();
            }
        }

        // ============== Apply Policies ==============
        function applyPolicies() {
            if (!state.selected) {
                showToast('No device selected', 'error');
                return;
            }
            
            var cfg = generateConfig();
            var btn = document.getElementById('applyBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Applying...';
            
            fetch('/api/devices/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ deviceId: state.selected, config: cfg })
            })
            .then(function(r) { return r.json(); })
            .then(function(res) {
                if (res.success) {
                    showToast('Policies applied to ' + state.selected, 'success');
                    // Refresh both config display AND state.devices
                    setTimeout(function() {
                        refreshConfig();
                        fetchDevices();
                    }, 500);
                } else {
                    showToast('Failed: ' + (res.error || 'Unknown error'), 'error');
                }
            })
            .catch(function(e) { showToast('Error: ' + e.message, 'error'); })
            .finally(function() {
                btn.disabled = false;
                btn.textContent = 'Apply Policies';
            });
        }

        // ============== Raw Config ==============
        function refreshConfig() {
            if (!state.selected) return;
            var box = document.getElementById('currentConfigBox');
            box.textContent = 'Loading...';
            
            fetch('/api/devices/' + state.selected + '/config')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    box.textContent = data.config || 'No configuration available';
                })
                .catch(function(e) {
                    box.textContent = 'Error loading config: ' + e.message;
                });
        }

        function pushRawConfig() {
            if (!state.selected) {
                showToast('No device selected', 'error');
                return;
            }
            
            var cfg = document.getElementById('rawConfigArea').value;
            if (!cfg.trim()) {
                showToast('Enter a configuration', 'error');
                return;
            }
            
            // Auto-enable emission when pushing raw config
            fetch('/api/devices/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ deviceId: state.selected, config: cfg, setEmission: true })
            })
            .then(function(r) { return r.json(); })
            .then(function(res) {
                if (res.success) {
                    // Update local state and UI to reflect emission is now ON
                    var d = state.devices.find(function(x) { return x.id === state.selected; });
                    if (d) {
                        d.emission_enabled = true;
                    }
                    updateEmissionUI(true);
                    updateStats();
                    renderDeviceList();
                    
                    showToast('Configuration pushed & emission enabled for ' + state.selected, 'success');
                    document.getElementById('rawConfigArea').value = '';
                    setTimeout(refreshConfig, 500);
                } else {
                    showToast('Failed: ' + (res.error || 'Unknown error'), 'error');
                }
            })
            .catch(function(e) { showToast('Error: ' + e.message, 'error'); });
        }

        function loadDefaultTemplate() {
            // Always load full template with INPUT/OUTPUT for custom config editing
            // This helps users when emission is OFF (device only has SERVICE section)
            document.getElementById('rawConfigArea').value = getDefaultBaseConfig();
            showToast('Template loaded (with INPUT/OUTPUT)', 'success');
        }

        // ============== Toast ==============
        var toastTimer;
        function showToast(msg, type) {
            var toast = document.getElementById('toast');
            clearTimeout(toastTimer);
            toast.textContent = msg;
            toast.className = 'toast ' + type + ' show';
            toastTimer = setTimeout(function() {
                toast.classList.remove('show');
            }, 4000);
        }

        // ============== POC Provisioner ==============
        var PROVISIONER_URL = 'http://localhost:8090';
        
        function getNextDeviceId() {
            if (state.devices.length === 0) return 1;
            var maxId = 0;
            state.devices.forEach(function(d) {
                var match = d.id.match(/device-(\d+)/);
                if (match) {
                    var id = parseInt(match[1]);
                    if (id > maxId) maxId = id;
                }
            });
            return maxId + 1;
        }
        
        function deployTestDevice() {
            var nextId = getNextDeviceId();
            showToast('Deploying device-' + nextId + '...', 'info');
            
            fetch(PROVISIONER_URL + '/api/deploy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ deviceId: nextId })
            })
            .then(function(r) { return r.json(); })
            .then(function(res) {
                if (res.success) {
                    showToast('device-' + nextId + ' deployed! Waiting for registration...', 'success');
                    setTimeout(fetchDevices, 2000);
                } else {
                    showToast('Deploy failed: ' + res.error, 'error');
                }
            })
            .catch(function(e) {
                showToast('Provisioner unavailable. Deploy manually with scripts.', 'error');
            });
        }
        
        function removeDevice(deviceId) {
            if (!confirm('Remove device-' + deviceId + '?')) return;
            
            showToast('Removing device-' + deviceId + '...', 'info');
            
            fetch(PROVISIONER_URL + '/api/remove', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ deviceId: deviceId })
            })
            .then(function(r) { return r.json(); })
            .then(function(res) {
                if (res.success) {
                    showToast('device-' + deviceId + ' removed!', 'success');
                    if (state.selected === 'device-' + deviceId) {
                        state.selected = null;
                        document.getElementById('noSelection').style.display = 'flex';
                        document.getElementById('deviceDetail').classList.remove('active');
                    }
                    setTimeout(fetchDevices, 1000);
                } else {
                    showToast('Remove failed: ' + res.error, 'error');
                }
            })
            .catch(function(e) {
                showToast('Provisioner unavailable. Remove manually with scripts.', 'error');
            });
        }

        // ============== Live Log Polling ==============
        function startLiveLogPolling() {
            // Always restart polling to pick up current device
            stopLiveLogPolling();
            
            var deviceId = state.selected ? parseInt(state.selected.replace('device-', '')) : null;
            if (!deviceId) return;
            
            // Fetch immediately
            fetchLogs();
            
            // Then poll every 3 seconds - fetchLogs will get current device
            liveLogInterval = setInterval(function() {
                fetchLogs();
            }, 3000);
        }
        
        function stopLiveLogPolling() {
            if (liveLogInterval) {
                clearInterval(liveLogInterval);
                liveLogInterval = null;
            }
        }
        
        function fetchLogs() {
            var deviceId = state.selected ? parseInt(state.selected.replace('device-', '')) : null;
            if (!deviceId) return;
            
            fetch('http://localhost:8090/api/logs?deviceId=' + deviceId, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(function(resp) { return resp.json(); })
            .then(function(data) {
                var logsBox = document.getElementById('liveLogsBox');
                if (data.success && data.logs) {
                    logsBox.textContent = data.logs;
                } else if (data.error) {
                    logsBox.textContent = 'Error: ' + data.error;
                } else {
                    logsBox.textContent = 'No logs available';
                }
            })
            .catch(function(err) {
                document.getElementById('liveLogsBox').textContent = 'Failed to fetch logs: ' + err.message;
            });
        }

        // ============== Event Listeners ==============
        document.getElementById('throttleRate').addEventListener('change', function() { updatePolicyState(); updatePreview(); });
        document.getElementById('throttleWindow').addEventListener('change', function() { updatePolicyState(); updatePreview(); });
        document.getElementById('grepField').addEventListener('change', function() { updatePolicyState(); updatePreview(); });
        document.getElementById('customRemoveFields').addEventListener('input', function() { updatePolicyState(); updatePreview(); });

        // ============== Init ==============
        fetchDevices();
        setInterval(fetchDevices, 5000);
    </script>
</body>
</html>
